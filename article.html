<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .back-button {
            margin-right: 15px;
        }
        .back-button button {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-button button:hover {
            background: #e0e0e0;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="global-bg"></div>
    <div id="global-bg-mask"></div>

    <div class="sidebar">
        <div class="logo">
            <img id="site-logo" src="https://via.placeholder.com/40" alt="Logo">
            <div>
                <h1 id="site-title">加载中...</h1>
                <p id="site-desc">加载中...</p>
            </div>
        </div>
        <div class="search-box">
            <input type="text" placeholder="搜索">
            <span>Ctrl+K</span>
        </div>
        <div id="sidebar-nav"></div>
        <div style="flex:1"></div>
        <div style="width:100%;margin-top:auto;">
            <div class="theme-toggle">
                <button id="dark-mode" title="深色模式"><i class="fas fa-moon"></i></button>
                <button id="light-mode" class="active" title="浅色模式"><i class="fas fa-sun"></i></button>
                <button id="system-mode" title="跟随系统"><i class="fas fa-adjust"></i></button>
            </div>
            <div class="bottom-icons" id="bottom-icons"></div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <div id="back-button" class="back-button" style="display:none;">
                    <button onclick="history.back()"><i class="fas fa-arrow-left"></i> 返回</button>
                </div>
                <h2 id="article-title">文章</h2>
            </div>

            <div id="article-iframe-wrap" style="width:100%;height:calc(100vh - 180px);">
                <iframe id="article-iframe" src="about:blank" style="width:100%;height:100%;border:0;border-radius:8px;overflow:auto;background:#fff"></iframe>
            </div>

            <div id="article-markdown-wrap" style="display:none;">
                <div class="all-search-box" style="margin-top:10px;">
                    <input id="article-search" type="text" placeholder="在文章中搜索...">
                </div>
                <div id="article-content" class="article-content" style="padding:16px;background:transparent;"></div>
            </div>
        </div>
    </div>

    <script>
    // 读取 config 设置背景
    fetch('./config.json').then(r=>r.json()).then(cfg=>{
        if(cfg.backgroundUrl) document.getElementById('global-bg').style.backgroundImage = `url('${cfg.backgroundUrl}')`;
    }).catch(()=>{});

    // 加载侧边栏必要的动态内容
    fetch('./config.json').then(r=>r.json()).then(data=>{
        if(data.logoUrl) document.getElementById('site-logo').src = data.logoUrl;
        if(data.title) document.getElementById('site-title').textContent = data.title;
        if(data.description) document.getElementById('site-desc').textContent = data.description;
    }).catch(()=>{});

    // 装载底部图标
    fetch('./under_link.csv').then(r=>r.text()).then(text=>{
        const lines = text.trim().split('\n').slice(1);
        const container = document.getElementById('bottom-icons');
        lines.forEach(line=>{
            const [icon, link] = line.split(',');
            const a = document.createElement('a'); 
            a.href = link; 
            a.target = '_blank'; 
            a.innerHTML = `<i class="fas fa-${icon}"></i>`; 
            container.appendChild(a);
        });
    }).catch(()=>{});

    // 解析 query param
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    const doc = getQueryParam('doc');
    if(!doc) {
        document.getElementById('article-title').textContent = '未指定文章';
    }

    // 搜索功能
    function searchInArticle(keyword) {
        const container = document.getElementById('article-content');
        if(!keyword) return;
        const text = container.textContent || '';
        const idx = text.toLowerCase().indexOf(keyword.toLowerCase());
        if(idx === -1) return;
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
            if(node.nodeType === 3) {
                if(node.nodeValue.toLowerCase().includes(keyword.toLowerCase())) {
                    const parent = node.parentElement;
                    parent.scrollIntoView({behavior:'smooth', block:'center'});
                    parent.style.background = 'rgba(255,235,59,0.15)';
                    setTimeout(()=> parent.style.background = '', 2000);
                    break;
                }
            }
        }
    }

    // 根据屏幕尺寸选择渲染模式
    function loadArticle() {
        const isLarge = window.innerWidth > 900;
        const iframeWrap = document.getElementById('article-iframe-wrap');
        const contentWrap = document.getElementById('article-markdown-wrap');
        const backButton = document.getElementById('back-button');
        const sidebar = document.querySelector('.sidebar');
        const containerEl = document.querySelector('.container');

        if(isLarge) {
            // 大屏模式 - 直接加载HTML文件
            contentWrap.style.display = 'none';
            iframeWrap.style.display = 'block';
            backButton.style.display = 'none';
            
            if(sidebar) {
                sidebar.style.display = '';
                const sideWidth = getComputedStyle(sidebar).width || (sidebar.offsetWidth + 'px');
                if(containerEl) containerEl.style.marginLeft = sideWidth;
            }
            
            if(doc) {
                // 直接加载HTML文件
                const htmlUrl = `./docs/${doc}.html`;
                const iframe = document.getElementById('article-iframe');
                iframe.src = htmlUrl;
                
                // 检查加载是否成功
                iframe.onload = function() {
                    document.getElementById('article-title').textContent = doc;
                };
                
                iframe.onerror = function() {
                    document.getElementById('article-title').textContent = '文档加载失败';
                    iframe.srcdoc = '<body>文档不存在或加载失败</body>';
                };
            }
        } else {
            // 小屏模式 - 加载HTML内容到div
            if(sidebar) sidebar.style.display = 'none';
            if(containerEl) containerEl.style.marginLeft = '0';
            iframeWrap.style.display = 'none';
            contentWrap.style.display = 'block';
            backButton.style.display = 'block';
            
            if(doc) {
                fetch(`./docs/${doc}.html`)
                    .then(response => {
                        if(!response.ok) throw new Error('Not found');
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('article-content').innerHTML = html;
                        document.getElementById('article-title').textContent = doc;
                    })
                    .catch(error => {
                        console.error('加载文档失败:', error);
                        document.getElementById('article-content').innerHTML = '<h1>文档加载失败</h1><p>请检查文档是否存在</p>';
                    });
            }
        }
    }

    // 初始加载
    loadArticle();
    
    // 窗口大小改变时重新加载
    window.addEventListener('resize', loadArticle);

    // 小屏搜索事件
    document.getElementById('article-search').addEventListener('input', e=>{
        const k = e.target.value.trim();
        if(k) searchInArticle(k);
    });

    </script>
</body>
</html>